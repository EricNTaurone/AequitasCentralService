version: "3.9"

services:
    postgres:
        image: postgres:16-alpine
        container_name: aequitas-postgres
        ports:
            - "6543:5432"
        env_file:
            - ./config/postgres/constants/${ENVIRONMENT}.env
            - ./config/postgres/constants/shared.env
            - ./config/docker/constants/${ENVIRONMENT}.env
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U aequitas -d aequitas_central"]
            interval: 10s
            timeout: 5s
            retries: 5
        volumes:
            - postgres-data:/var/lib/postgresql/data

    app:
        build:
            context: .
            dockerfile: config/docker/Dockerfile
        image: aequitas-central-service:latest
        depends_on:
            postgres:
                condition: service_healthy
        env_file:
            - ./config/web/constants/shared.env
            - ./config/web/constants/${ENVIRONMENT}.env
            - ./config/postgres/constants/shared.env
            - ./config/postgres/constants/${ENVIRONMENT}.env
            - ./config/docker/constants/${ENVIRONMENT}.env
        ports:
            - "8080:8080"
            - "5005:5005"
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
            interval: 15s
            timeout: 5s
            retries: 5

volumes:
    postgres-data: {}
