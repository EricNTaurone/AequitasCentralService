# Requirements Matrix

| Feature | LLD Reference | Acceptance Tests |
| --- | --- | --- |
| Multi-tenant data model with RLS & firm-scoped access | `AequitasCentralService LLD` – Requirements, Security & Tenancy, Persistence Model | - `V1__baseline.sql` adds `firm_id` columns, composite FKs, and RLS policies referencing session GUCs.<br>- Tenant-aware datasource + `TenantContextFilter` set/reset GUCs per JWT.<br>- `TimeEntryControllerIntegrationTest` performs requests with scoped JWTs to ensure firm isolation. |
| User roster & role management APIs | LLD – Entities (Firm/UserProfile), Roles & Permissions, User stories US-001/US-002 | - `UserProfileServiceTest` enforces role-based roster visibility + admin-only role updates.<br>- `UserProfileControllerIntegrationTest` covers `/api/v1/users/me`, `/api/v1/users`, and `/api/v1/users/{id}/role` with employee/manager/admin JWTs to prove contracts and access controls. |
| Role-based workflows (Employee, Manager, Admin) | LLD – Roles & Permissions, Ports & Use Cases (Update/Approve pseudocode) | - `TimeEntryCommandServiceTest` asserts employee-only edits and manager approval rules.<br>- Integration test submits as employee and approves as manager to exercise workflow boundaries. |
| Time entry lifecycle (CRUD → submit → approve) | LLD – Domain Core, API Design, Data Flow (Approve) | - `TimeEntryTest` validates aggregate transitions and invariants.<br>- `TimeEntryControllerIntegrationTest` drives `/api/v1/entries` happy path (create → submit → approve → fetch). |
| Idempotent command handling with outbox events | LLD – Goals (Reliable exports), Eventing, Transactional Outbox & Relay | - `IdempotencyServiceTest` verifies cached responses per key.<br>- Integration test replays create and approve with identical `Idempotency-Key` headers to assert stable IDs.<br>- `OutboxRelay` publishes `ENTRY_APPROVED.v1` payloads per approval. |
| Customer & project ownership validation | LLD – Design (Update Use Case), Data Model invariants | - Service tests ensure mismatch errors, while Flyway migration enforces `(firm_id, customer_id)` FK for projects ensuring DB-level safety. |
| Integration readiness (Clio export hook, encrypted tokens) | LLD – Integration: Clio, Secrets & Key Management, Data Structures | - `OutboxRelay` batches SNS-style publishes; outbox table stores JSON payload + dedupe key.<br>- `integration_configs` table holds encrypted tokens ready for Clio OAuth credentials. |
| Observability & operational excellence (metrics, logging, runbooks) | LLD – Operational Excellence, Monitoring, Runbooks | - Actuator endpoints + Prometheus registry + correlation ID filter in `logback-spring.xml`.<br>- README documents metrics/alerts/runbooks. |
| Governance & quality gates (lint, coverage, mutation testing) | Prompt requirements + LLD Operational Excellence (quality) | - Maven `verify` wires Spotless, Checkstyle, PMD, SpotBugs, JaCoCo (100% line & branch for `domain` and `app.service`).<br>- `ci.yml` executes verify + PIT mutation coverage per push/PR. |
